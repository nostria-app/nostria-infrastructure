# Global options
{
    # Automatic HTTPS with Let's Encrypt
    auto_https on
    email admin@nostria.app
    
    # Enable admin API on localhost only
    admin localhost:2019
    
    # Logging configuration
    log {
        output file /var/log/caddy/caddy.log
        format json
        level INFO
    }
    
    # Security settings
    servers {
        metrics
    }
}

# Main site configuration for test.ribo.eu.nostria.app
test.ribo.eu.nostria.app {
    # Reverse proxy to strfry relay
    reverse_proxy 127.0.0.1:7777 {
        # WebSocket support
        header_up Connection {>Connection}
        header_up Upgrade {>Upgrade}
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        
        # Health check for strfry backend
        health_uri /health
        health_interval 30s
        health_timeout 5s
    }

    # Security headers
    header {
        # Remove server information
        -Server
        -X-Powered-By
        
        # Security headers
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
        Content-Security-Policy "default-src 'self'; connect-src 'self' wss: ws:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
        
        # HSTS - enforce HTTPS for 1 year
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Permissions policy
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()"
    }

    # Access logging
    log {
        output file /var/log/caddy/test.ribo.eu.nostria.app.access.log
        format json {
            time_format "2006-01-02T15:04:05.000Z07:00"
            message_key "message"
            level_key "level"
            time_key "timestamp"
            logger_key "logger"
            caller_key "caller"
        }
    }

    # NIP-11 relay information endpoint
    handle /.well-known/nostr.json {
        respond `{
            "names": {},
            "relays": {
                "test.ribo.eu.nostria.app": ["wss://test.ribo.eu.nostria.app"]
            }
        }` 200 {
            Content-Type "application/json"
            Cache-Control "public, max-age=3600"
        }
    }

    # Health check endpoint
    handle /health {
        respond "OK" 200 {
            Content-Type "text/plain"
            Cache-Control "no-cache, no-store, must-revalidate"
        }
    }

    # Status endpoint (basic relay info)
    handle /status {
        respond `{
            "relay": "Nostria VM Relay",
            "version": "1.0.0",
            "description": "High-performance nostr relay running on dedicated VM infrastructure",
            "contact": "admin@nostria.app",
            "supported_nips": [1, 2, 4, 9, 11, 15, 16, 20, 22, 28, 33, 40],
            "software": "strfry + caddy",
            "timestamp": "{time.now.unix}"
        }` 200 {
            Content-Type "application/json"
            Cache-Control "public, max-age=300"
        }
    }

    # Robots.txt
    handle /robots.txt {
        respond `User-agent: *
Disallow: /

# This is a nostr relay, not a website
# For more information about nostr, visit https://nostr.com
` 200 {
            Content-Type "text/plain"
            Cache-Control "public, max-age=86400"
        }
    }

    # Favicon (prevent 404s)
    handle /favicon.ico {
        respond "" 204
    }

    # Rate limiting for WebSocket connections
    rate_limit {
        zone static_example {
            key {remote_host}
            events 100
            window 1m
        }
    }

    # Default route - all other requests go to strfry
    handle {
        reverse_proxy 127.0.0.1:7777 {
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
}

# Monitoring endpoint (internal access only)
# Access via: http://localhost:8080/metrics
localhost:8080 {
    # Caddy metrics endpoint
    handle /metrics {
        metrics
    }
    
    # strfry monitoring proxy
    handle /strfry/* {
        uri strip_prefix /strfry
        reverse_proxy 127.0.0.1:7778
    }
    
    # Health check for internal monitoring
    handle /health {
        respond `{
            "status": "healthy",
            "timestamp": "{time.now.unix}",
            "services": {
                "caddy": "running",
                "strfry": "running"
            }
        }` 200 {
            Content-Type "application/json"
        }
    }
    
    # Admin interface (Caddy API)
    handle /admin/* {
        reverse_proxy localhost:2019
    }
}

# Additional site for stats/monitoring (optional)
# stats.test.ribo.eu.nostria.app {
#     root * /var/www/relay-stats
#     file_server
#     
#     # Basic auth for stats access
#     basicauth {
#         admin $2a$14$hashed_password_here
#     }
#     
#     # Proxy to strfry monitoring
#     handle /api/* {
#         uri strip_prefix /api
#         reverse_proxy 127.0.0.1:7778
#     }
# }
